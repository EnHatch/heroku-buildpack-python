#!/usr/bin/env bash
# Build Path: /app/.heroku/vendor/

OUT_PREFIX=$1

# Use new path, containing autoconf.
export PATH="/app/.heroku/python/bin/:$PATH"
hash -r


echo "Building ffmpeg..."

SOURCE_TARBALL='http://ffmpeg.org/releases/ffmpeg-2.7.tar.bz2'

curl -L $SOURCE_TARBALL | tar jx

cd ffmpeg-2.7
./configure --prefix=$OUT_PREFIX --disable-static --enable-shared --disable-doc
make
make install

PROFILE_PATH="$HOME/.profile.d/ffmpeg.sh"
mkdir -p $(dirname $PROFILE_PATH)
echo 'export PATH="$PATH:$HOME/.heroku/vendor/ffmpeg/bin"' >> $PROFILE_PATH
echo 'export LD_LIBRARY_PATH="$LD_LIBRARY_PATH:$HOME/.heroku/vendor/ffmpeg/lib"' >> $PROFILE_PATH
echo 'export PKG_CONFIG_PATH="$PKG_CONFIG_PATH:$HOME/.heroku/vendor/ffmpeg/lib/pkgconfig"' >> $PROFILE_PATH

source ~/.profile.d/ffmpeg.sh

# Cleanup
cd ..
